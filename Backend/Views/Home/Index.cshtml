@{
    ViewData["PageTitle"] = "Home";
    var user_id = "1"; // Replace with actual user ID
}

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center">
        <span class="h1 mb-4">Certifications</span>
        <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#addCertificateModal">
            Add New <i class="bi bi-plus-lg"></i>
        </button>
    </div>
    <!-- Certificates Table -->
    <table class="table" id="certificationsTable">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Certification</th>
                <th scope="col">Certified Date</th>
                <th scope="col">Status</th>
                <th scope="col">Expiry Date</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody id="certificationsBody">
            <!-- Dynamic certificate rows will be inserted here -->
        </tbody>
    </table>
    <div class="alert alert-warning" role="alert" id="noCertificationsAlert" style="display:none;">
        You don't have any certifications yet.
    </div>
    
    <!-- Modal for adding a new certificate -->
    <div class="modal fade" id="addCertificateModal" tabindex="-1" aria-labelledby="addCertificateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="addCertificateModalLabel">Add New Certificate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Modal body with form -->
                <div class="modal-body">
                    <form id="addCertificateForm">
                        <div class="mb-3">
                            <label for="certificateName" class="form-label">Certificate Name</label>
                            <input type="text" class="form-control" id="certificateName" placeholder="Enter certificate name" />
                        </div>
                        <div class="mb-3">
                            <label for="certifiedDate" class="form-label">Certified Date</label>
                            <input type="date" class="form-control" id="certifiedDate" />
                        </div>
                        <div class="mb-3">
                            <label for="validTill" class="form-label">Valid Till</label>
                            <input type="date" class="form-control" id="validTill" />
                        </div>
                    </form>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addCertificateBtn">Add Certificate</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load certificates from the API and populate the table
    function loadCertificates() {
        $.ajax({
            url: '/api/certificates',
            type: 'GET',
            success: function (data) {
                var tbody = $('#certificationsBody');
                tbody.empty();
                if (data.length === 0) {
                    $('#noCertificationsAlert').show();
                } else {
                    $('#noCertificationsAlert').hide();
                    $.each(data, function (index, cert) {
                        // Format dates and compute a simple status based on ValidTill
                        var certifiedDate = new Date(cert.certifiedDate).toLocaleDateString();
                        var validTill = new Date(cert.validTill).toLocaleDateString();
                        var status = (new Date(cert.validTill) > new Date()) ? "Active" : "Expired";
                        var row = '<tr>' +
                            '<th scope="row">' + (index + 1) + '</th>' +
                            '<td>' + cert.certificateName + '</td>' +
                            '<td>' + certifiedDate + '</td>' +
                            '<td>' + status + '</td>' +
                            '<td>' + validTill + '</td>' +
                            '<td><a href="javascript:void(0);" onclick="editCertificate(' + cert.Id + ')"><i class="bi bi-pencil-square text-primary"></i></a></td>' +
                            '<td><a href="javascript:void(0);" onclick="deleteCertificate(' + cert.Id + ')"><i class="bi bi-trash-fill text-danger"></i></a></td>' +
                            '</tr>';
                        tbody.append(row);
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching certificates:", error);
            }
        });
    }

    // Add a new certificate using the POST API
    function addCertificate() {
        var certData = {
            CertificateName: $('#certificateName').val(),
            CertifiedDate: $('#certifiedDate').val(),
            ValidTill: $('#validTill').val(),
        };
        $.ajax({
            url: '/api/certificates',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(certData),
            success: function (response) {
                $('#addCertificateModal').modal('hide');
                $('#addCertificateForm')[0].reset();
                loadCertificates();
            },
            error: function (xhr, status, error) {
                console.error("Error adding certificate:", error);
            }
        });
    }

    // Stub for editing a certificate
    function editCertificate(id) {
        console.log("Edit certificate with id:", id);
    }

    // Delete a certificate using the DELETE API
    function deleteCertificate(id) {
        $.ajax({
            url: '/api/certificates/' + id,
            type: 'DELETE',
            success: function () {
                loadCertificates();
            },
            error: function (xhr, status, error) {
                console.error("Error deleting certificate:", error);
            }
        });
    }

    // On document ready, load certificates and bind the Add Certificate button click event
    $(document).ready(function () {
        loadCertificates();
        $('#addCertificateBtn').click(function () {
            addCertificate();
        });
    });
</script>